#!/usr/bin/env node

/**
 * Service backend pour les notifications Firebase
 * Int√©gration avec l'API immobilier
 */

const admin = require('firebase-admin');
const serviceAccount = require('./appimmofront/app-immo-notifications-firebase-adminsdk-fbsvc-5c87fe303d.json');

// Initialiser Firebase Admin
admin.initializeApp({
  credential: admin.credential.cert(serviceAccount),
  projectId: 'app-immo-notifications'
});

class BackendNotificationService {
  constructor() {
    this.messaging = admin.messaging();
  }

  /**
   * 1. NOUVELLES ANNONCES - Notifier les utilisateurs pour de nouvelles annonces correspondant √† leurs recherches
   */
  async notifyNewMatchingListings(searchCriteria, newListings) {
    try {
      console.log(`üîç Recherche de nouvelles annonces pour: ${searchCriteria.location}`);
      
      // R√©cup√©rer les utilisateurs qui ont des recherches similaires
      const usersToNotify = await this.getUsersWithSimilarSearches(searchCriteria);
      
      const notifications = [];
      
      for (const user of usersToNotify) {
        const message = {
          notification: {
            title: 'üè† Nouvelles annonces trouv√©es !',
            body: `${newListings.length} nouvelle(s) annonce(s) correspondent √† vos crit√®res de recherche`
          },
          data: {
            type: 'new_matching_listings',
            userId: user.id,
            searchCriteria: JSON.stringify(searchCriteria),
            listingsCount: newListings.length.toString(),
            listings: JSON.stringify(newListings.map(l => ({ 
              id: l.id, 
              title: l.title, 
              price: l.price,
              location: l.location 
            }))),
            screen: 'search_results',
            params: JSON.stringify({ 
              searchId: searchCriteria.id,
              highlightNew: true 
            })
          },
          token: user.fcmToken,
          android: {
            priority: 'high',
            notification: {
              sound: 'default',
              channelId: 'new_listings',
              color: '#4CAF50'
            }
          },
          apns: {
            payload: {
              aps: {
                sound: 'default',
                badge: 1,
                category: 'NEW_LISTINGS'
              }
            }
          }
        };

        const response = await this.messaging.send(message);
        notifications.push({ userId: user.id, messageId: response });
        console.log(`‚úÖ Notification envoy√©e √† ${user.name}: ${response}`);
      }

      return {
        success: true,
        notificationsSent: notifications.length,
        notifications: notifications
      };

    } catch (error) {
      console.error('‚ùå Erreur notification nouvelles annonces:', error);
      throw error;
    }
  }

  /**
   * 2. MESSAGE RE√áU - Notifier quand un utilisateur re√ßoit un nouveau message
   */
  async notifyNewMessage(conversationId, senderId, recipientId, messageContent) {
    try {
      console.log(`üí¨ Nouveau message de ${senderId} vers ${recipientId}`);
      
      // R√©cup√©rer les informations du destinataire
      const recipient = await this.getUserById(recipientId);
      const sender = await this.getUserById(senderId);
      
      if (!recipient || !recipient.fcmToken) {
        console.log(`‚ö†Ô∏è Aucun token FCM trouv√© pour l'utilisateur ${recipientId}`);
        return { success: false, error: 'No FCM token found' };
      }

      const message = {
        notification: {
          title: `üí¨ Nouveau message de ${sender.name}`,
          body: messageContent.length > 50 ? messageContent.substring(0, 50) + '...' : messageContent
        },
        data: {
          type: 'new_message',
          senderId: senderId,
          senderName: sender.name,
          conversationId: conversationId,
          messagePreview: messageContent,
          screen: 'chat',
          params: JSON.stringify({ 
            conversationId: conversationId,
            highlightNew: true 
          })
        },
        token: recipient.fcmToken,
        android: {
          priority: 'high',
          notification: {
            sound: 'default',
            channelId: 'messages',
            color: '#2196F3'
          }
        },
        apns: {
          payload: {
            aps: {
              sound: 'default',
              badge: 1,
              category: 'NEW_MESSAGE'
            }
          }
        }
      };

      const response = await this.messaging.send(message);
      console.log(`‚úÖ Notification message envoy√©e: ${response}`);
      
      return {
        success: true,
        messageId: response,
        recipientId: recipientId
      };

    } catch (error) {
      console.error('‚ùå Erreur notification nouveau message:', error);
      throw error;
    }
  }

  /**
   * 3. CHANGEMENT DE STATUT D'ANNONCE - Notifier les changements de statut
   */
  async notifyListingStatusChange(listingId, oldStatus, newStatus) {
    try {
      console.log(`üìù Changement de statut pour l'annonce ${listingId}: ${oldStatus} ‚Üí ${newStatus}`);
      
      // R√©cup√©rer les informations de l'annonce et du propri√©taire
      const listing = await this.getListingById(listingId);
      const owner = await this.getUserById(listing.ownerId);
      
      if (!owner || !owner.fcmToken) {
        console.log(`‚ö†Ô∏è Aucun token FCM trouv√© pour le propri√©taire ${listing.ownerId}`);
        return { success: false, error: 'No FCM token found' };
      }

      let title, body, color;
      
      switch (newStatus) {
        case 'APPROVED':
          title = '‚úÖ Annonce approuv√©e !';
          body = `Votre annonce "${listing.title}" a √©t√© approuv√©e et est maintenant visible`;
          color = '#4CAF50';
          break;
        case 'REJECTED':
          title = '‚ùå Annonce rejet√©e';
          body = `Votre annonce "${listing.title}" a √©t√© rejet√©e. Consultez les raisons`;
          color = '#F44336';
          break;
        case 'SOLD':
          title = 'üè† Annonce vendue !';
          body = `F√©licitations ! Votre annonce "${listing.title}" a √©t√© vendue`;
          color = '#FF9800';
          break;
        case 'EXPIRED':
          title = '‚è∞ Annonce expir√©e';
          body = `Votre annonce "${listing.title}" a expir√©. Renouvelez-la si n√©cessaire`;
          color = '#FF5722';
          break;
        default:
          title = 'üìù Statut modifi√©';
          body = `Le statut de votre annonce "${listing.title}" a chang√©`;
          color = '#607D8B';
      }

      const message = {
        notification: {
          title: title,
          body: body
        },
        data: {
          type: 'listing_status_change',
          listingId: listingId,
          oldStatus: oldStatus,
          newStatus: newStatus,
          listingTitle: listing.title,
          screen: 'my_listings',
          params: JSON.stringify({ 
            listingId: listingId,
            highlightStatus: newStatus 
          })
        },
        token: owner.fcmToken,
        android: {
          priority: 'high',
          notification: {
            sound: 'default',
            channelId: 'listing_status',
            color: color
          }
        },
        apns: {
          payload: {
            aps: {
              sound: 'default',
              badge: 1,
              category: 'LISTING_STATUS'
            }
          }
        }
      };

      const response = await this.messaging.send(message);
      console.log(`‚úÖ Notification changement statut envoy√©e: ${response}`);
      
      return {
        success: true,
        messageId: response,
        ownerId: listing.ownerId
      };

    } catch (error) {
      console.error('‚ùå Erreur notification changement statut:', error);
      throw error;
    }
  }

  /**
   * 4. RAPPEL DE PAIEMENT - Notifier les rappels de paiement √† renouveler
   */
  async notifyPaymentReminder(userId, paymentType, dueDate, amount) {
    try {
      console.log(`üí≥ Rappel de paiement pour l'utilisateur ${userId}`);
      
      // R√©cup√©rer les informations de l'utilisateur
      const user = await this.getUserById(userId);
      
      if (!user || !user.fcmToken) {
        console.log(`‚ö†Ô∏è Aucun token FCM trouv√© pour l'utilisateur ${userId}`);
        return { success: false, error: 'No FCM token found' };
      }

      let title, body;
      
      switch (paymentType) {
        case 'SUBSCRIPTION':
          title = 'üí≥ Abonnement √† renouveler';
          body = `Votre abonnement premium expire le ${dueDate}. Renouvelez maintenant !`;
          break;
        case 'LISTING_FEE':
          title = 'üí∞ Frais d\'annonce √† payer';
          body = `Des frais de ${amount}‚Ç¨ sont dus pour vos annonces. Payez maintenant !`;
          break;
        case 'PREMIUM_FEATURES':
          title = '‚≠ê Fonctionnalit√©s premium';
          body = `D√©bloquez des fonctionnalit√©s premium pour ${amount}‚Ç¨/mois !`;
          break;
        default:
          title = 'üí≥ Paiement requis';
          body = `Un paiement de ${amount}‚Ç¨ est requis. Effectuez le paiement maintenant !`;
      }

      const message = {
        notification: {
          title: title,
          body: body
        },
        data: {
          type: 'payment_reminder',
          paymentType: paymentType,
          dueDate: dueDate,
          amount: amount.toString(),
          userName: user.name,
          screen: 'payment',
          params: JSON.stringify({ 
            paymentType: paymentType,
            highlightUrgent: true 
          })
        },
        token: user.fcmToken,
        android: {
          priority: 'high',
          notification: {
            sound: 'default',
            channelId: 'payments',
            color: '#FF5722'
          }
        },
        apns: {
          payload: {
            aps: {
              sound: 'default',
              badge: 1,
              category: 'PAYMENT_REMINDER'
            }
          }
        }
      };

      const response = await this.messaging.send(message);
      console.log(`‚úÖ Notification rappel paiement envoy√©e: ${response}`);
      
      return {
        success: true,
        messageId: response,
        userId: userId
      };

    } catch (error) {
      console.error('‚ùå Erreur notification rappel paiement:', error);
      throw error;
    }
  }

  // M√©thodes utilitaires (√† adapter selon votre base de donn√©es)
  async getUsersWithSimilarSearches(searchCriteria) {
    // Simulation - √† remplacer par votre logique de base de donn√©es
    return [
      { id: 'user_123', name: 'Jean Dupont', fcmToken: 'fcm_token_123' },
      { id: 'user_456', name: 'Marie Martin', fcmToken: 'fcm_token_456' }
    ];
  }

  async getUserById(userId) {
    // Simulation - √† remplacer par votre logique de base de donn√©es
    const users = {
      'user_123': { id: 'user_123', name: 'Jean Dupont', fcmToken: 'fcm_token_123' },
      'user_456': { id: 'user_456', name: 'Marie Martin', fcmToken: 'fcm_token_456' },
      'user_789': { id: 'user_789', name: 'Pierre Durand', fcmToken: 'fcm_token_789' }
    };
    return users[userId];
  }

  async getListingById(listingId) {
    // Simulation - √† remplacer par votre logique de base de donn√©es
    return {
      id: listingId,
      title: 'Appartement 3 pi√®ces avec balcon',
      ownerId: 'user_789',
      status: 'APPROVED'
    };
  }
}

// Exporter la classe
module.exports = BackendNotificationService;

// Test du service
if (require.main === module) {
  const service = new BackendNotificationService();
  
  console.log('üß™ Test du service backend de notifications...\n');
  
  // Test des 4 types de notifications
  Promise.all([
    service.notifyNewMatchingListings(
      { location: 'Paris', priceRange: '200000-500000' },
      [{ id: '1', title: 'Appartement Paris', price: 350000 }]
    ),
    service.notifyNewMessage('conv_123', 'user_456', 'user_123', 'Bonjour, votre appartement m\'int√©resse !'),
    service.notifyListingStatusChange('listing_123', 'PENDING', 'APPROVED'),
    service.notifyPaymentReminder('user_123', 'SUBSCRIPTION', '2024-02-15', 29.99)
  ]).then(() => {
    console.log('\nüéâ Tous les tests termin√©s !');
  }).catch(error => {
    console.error('‚ùå Erreur lors des tests:', error);
  });
}
